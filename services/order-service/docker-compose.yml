version: '3.8'

services:
  order-service:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    container_name: order-service
    ports:
      - "8003:8003"
    environment:
      - SERVER_PORT=8003
      - DATABASE_URL=postgres://postgres:postgres@order-postgres:5432/orders?sslmode=disable
      - USER_SERVICE_URL=http://user-service:8001  # ← DÜZELTİLDİ (container ismi)
      - PRODUCT_SERVICE_URL=http://django-service:8000
      - PAYMENT_SERVICE_URL=http://payment-service:8085  # ← DÜZELTİLDİ (container ismi)
      - JWT_SECRET=your-secret-key
      - OTEL_ENDPOINT=otel-collector:4317
      - OTEL_SERVICE_NAME=order-service
      - SERVICE_NAME=order-service
    depends_on:
      order-postgres:
        condition: service_healthy
    networks:
      - order-network
      - microservices-network  # ← DÜZELTİLDİ (django-service_default yerine)
    restart: unless-stopped

  order-postgres:
    image: postgres:15.15
    platform: linux/amd64
    container_name: order-postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=orders
    ports:
      - "5435:5432"
    volumes:
      - order_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d orders"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - order-network
    restart: unless-stopped

volumes:
  order_postgres_data:

networks:
  order-network:
    driver: bridge
  microservices-network:  # ← DÜZELTİLDİ
    external: true